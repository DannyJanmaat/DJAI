<Page
    x:Class="DJAI.Views.ChatPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:DJAI.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:DJAI.Models"
    xmlns:controls="using:DJAI.Controls"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

	<Grid Padding="12">
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- Header met provider info -->
		<StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12">
			<TextBlock Text="{x:Bind ViewModel.AIServiceName, Mode=OneWay}"
                       FontWeight="SemiBold"
                       VerticalAlignment="Center"
                       Margin="0,0,12,0"/>
			<TextBlock Text="{x:Bind ViewModel.CurrentModelName, Mode=OneWay}"
                       Opacity="0.7"
                       VerticalAlignment="Center"/>
		</StackPanel>

		<!-- Chatberichten -->
		<ListView Grid.Row="1"
                  ItemsSource="{x:Bind ViewModel.Messages, Mode=OneWay}"
                  Margin="0,0,0,12"
                  SelectionMode="None">
			<ListView.ItemTemplate>
				<DataTemplate x:DataType="models:ChatMessage">
					<Border Margin="0,6"
                            Padding="12"
                            CornerRadius="8"
                            Background="{x:Bind Role, Converter={StaticResource RoleToBackgroundConverter}}">
						<StackPanel>
							<Grid>
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="*"/>
									<ColumnDefinition Width="Auto"/>
								</Grid.ColumnDefinitions>
								<TextBlock Text="{x:Bind Role}"
                                          FontWeight="Bold"
                                          Margin="0,0,0,8"/>
								<TextBlock Grid.Column="1"
                                          Text="{x:Bind Timestamp}"
                                          Opacity="0.5"
                                          FontSize="12"
                                          Margin="8,0,0,8"/>
							</Grid>

							<!-- Gebruik MarkdownTextBlock voor inhoud met code highlighting -->
							<controls:MarkdownTextBlock
                                Text="{x:Bind Content}"
                                MinHeight="20"
                                Visibility="{x:Bind IsComplete}"/>

							<!-- Fallback naar gewone TextBlock als bericht nog niet compleet is -->
							<TextBlock
                                Text="{x:Bind Content}"
                                TextWrapping="Wrap"
                                Visibility="{x:Bind IsComplete, Converter={StaticResource BooleanInverseConverter}}"/>
						</StackPanel>
					</Border>
				</DataTemplate>
			</ListView.ItemTemplate>
		</ListView>

		<!-- Invoerveld en verzendknop -->
		<Grid Grid.Row="2">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="Auto"/>
			</Grid.ColumnDefinitions>

			<TextBox Grid.Column="0"
                     Text="{x:Bind ViewModel.UserInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     PlaceholderText="Typ je bericht hier..."
                     KeyDown="UserInput_KeyDown"
                     MinHeight="60"
                     TextWrapping="Wrap"
                     AcceptsReturn="True"
                     Margin="0,0,8,0"/>

			<Button Grid.Column="1"
                    Content="Verzenden"
                    Command="{x:Bind ViewModel.SendMessageCommand}"
                    IsEnabled="{x:Bind ViewModel.IsGenerating, Mode=OneWay, Converter={StaticResource BooleanInverseConverter}}"
                    VerticalAlignment="Bottom"/>
		</Grid>

		<!-- Laad indicator -->
		<ProgressRing Grid.Row="1"
                      IsActive="{x:Bind ViewModel.IsGenerating, Mode=OneWay}"
                      Width="50"
                      Height="50"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"/>
	</Grid>
</Page>